<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶è¨ˆç°¿ã‚¢ãƒ—ãƒª - æœ€çµ‚å®‰å®šç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .negative-amount { color: #ef4444; }
        input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; }
        body { font-family: sans-serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen pb-10 text-gray-800">
    <div id="app" class="max-w-6xl mx-auto p-4">
        <h1 class="text-3xl font-bold text-center my-6 text-blue-900">å®¶è¨ˆç°¿ã‚¢ãƒ—ãƒª</h1>
        
        <div class="bg-white p-4 rounded-xl shadow-md mb-6 flex justify-between items-center border-b-4 border-blue-500">
            <button id="prevMonth" class="px-6 py-2 bg-blue-500 text-white rounded-lg shadow hover:bg-blue-600 transition-all font-bold">å‰æœˆ</button>
            <h2 id="currentMonthDisplay" class="text-2xl font-bold text-center min-w-[150px]">èª­ã¿è¾¼ã¿ä¸­...</h2>
            <button id="nextMonth" class="px-6 py-2 bg-blue-500 text-white rounded-lg shadow hover:bg-blue-600 transition-all font-bold">æ¬¡æœˆ</button>
        </div>
        
        <div class="bg-white p-6 rounded-xl shadow-md mb-6 border-l-8 border-green-500">
            <form id="expenseForm" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <select id="userSelect" class="p-3 border rounded-lg font-bold bg-gray-50">
                    <option value="user1">å¤ªé™½</option>
                    <option value="user2">æ„›è¯éŸ³</option>
                </select>
                <input id="dateInput" type="number" placeholder="æ—¥" class="p-3 border rounded-lg" />
                <input id="descriptionInput" type="text" placeholder="å†…å®¹" class="p-3 border rounded-lg" />
                <div class="flex gap-2">
                    <input id="amountInput" type="number" placeholder="é‡‘é¡" class="p-3 border rounded-lg flex-1 font-mono" />
                    <button id="submitButton" type="submit" class="px-6 py-3 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600 active:scale-95 transition-all">è¿½åŠ </button>
                </div>
            </form>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-yellow-400">
                <div class="flex justify-between items-center mb-4 text-yellow-600 font-bold">
                    <h3 class="text-xl">å¤ªé™½</h3>
                    <div id="user1-regular-list" class="flex flex-wrap gap-1"></div>
                </div>
                <div class="mb-4 p-3 bg-gray-50 rounded-lg text-sm space-y-1">
                    <p class="flex justify-between font-medium"><span>å‰æœˆæŒè¶Šã—:</span> <span id="user1-carryover" class="font-bold text-gray-800">0å††</span></p>
                    <p class="flex justify-between text-blue-600"><span>å½“æœˆåˆè¨ˆ:</span> <span id="user1-current">0å††</span></p>
                    <p class="flex justify-between border-t pt-1 font-bold text-lg text-gray-800"><span>ç·åˆè¨ˆ:</span> <span id="user1-total">0å††</span></p>
                </div>
                <table class="w-full text-sm"><tbody id="user1-expenses"></tbody></table>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-blue-400">
                <div class="flex justify-between items-center mb-4 text-blue-600 font-bold">
                    <h3 class="text-xl">æ„›è¯éŸ³</h3>
                    <div id="user2-regular-list" class="flex flex-wrap gap-1"></div>
                </div>
                <div class="mb-4 p-3 bg-gray-50 rounded-lg text-sm space-y-1">
                    <p class="flex justify-between font-medium"><span>å‰æœˆæŒè¶Šã—:</span> <span id="user2-carryover" class="font-bold text-gray-800">0å††</span></p>
                    <p class="flex justify-between text-blue-600"><span>å½“æœˆåˆè¨ˆ:</span> <span id="user2-current">0å††</span></p>
                    <p class="flex justify-between border-t pt-1 font-bold text-lg text-gray-800"><span>ç·åˆè¨ˆ:</span> <span id="user2-total">0å††</span></p>
                </div>
                <table class="w-full text-sm"><tbody id="user2-expenses"></tbody></table>
            </div>
        </div>

        <div class="mt-8 bg-white p-6 rounded-xl shadow-md border-2 border-purple-300">
            <h3 class="text-2xl font-bold mb-6 text-purple-700">ğŸ’³ æœˆæœ«ç²¾ç®—</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                <div class="p-5 rounded-2xl border-2 border-yellow-300 bg-yellow-50">
                    <h4 class="font-bold mb-3 text-yellow-800">å¤ªé™½ ã®ç²¾ç®—</h4>
                    <div class="space-y-3">
                        <div class="flex justify-between text-gray-600"><span>ç¾åœ¨ã®åˆè¨ˆ:</span><span id="user1-settlement-total" class="font-bold text-gray-800">0å††</span></div>
                        <div class="flex justify-between items-center text-red-600">
                            <span class="font-bold italic text-sm">è¿”é‡‘é¡:</span>
                            <input id="user1-refund" type="number" class="w-32 p-2 border-2 border-yellow-400 rounded-lg text-right font-bold outline-none focus:bg-white" />
                        </div>
                        <div class="flex justify-between pt-3 border-t-2 border-yellow-200 font-bold text-gray-800">
                            <span>ç¿ŒæœˆæŒè¶Š:</span><span id="user1-next-carryover" class="text-2xl text-yellow-900 underline font-black">0å††</span>
                        </div>
                    </div>
                </div>
                <div class="p-5 rounded-2xl border-2 border-blue-300 bg-blue-50">
                    <h4 class="font-bold mb-3 text-blue-800">æ„›è¯éŸ³ ã®ç²¾ç®—</h4>
                    <div class="space-y-3">
                        <div class="flex justify-between text-gray-600"><span>ç¾åœ¨ã®åˆè¨ˆ:</span><span id="user2-settlement-total" class="font-bold text-gray-800">0å††</span></div>
                        <div class="flex justify-between items-center text-red-600">
                            <span class="font-bold italic text-sm">è¿”é‡‘é¡:</span>
                            <input id="user2-refund" type="number" class="w-32 p-2 border-2 border-blue-400 rounded-lg text-right font-bold outline-none focus:bg-white" />
                        </div>
                        <div class="flex justify-between pt-3 border-t-2 border-blue-200 font-bold text-gray-800">
                            <span>ç¿ŒæœˆæŒè¶Š:</span><span id="user2-next-carryover" class="text-2xl text-blue-900 font-black underline">0å††</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex flex-col items-center">
                <button id="settlementButton" class="px-12 py-4 bg-purple-600 text-white rounded-full font-black text-xl shadow-lg hover:bg-purple-700 active:scale-95 transition-all">ç²¾ç®—ã‚’ç¢ºå®šã—ã¦ç¿Œæœˆã¸</button>
                <p id="settlementStatus" class="text-sm font-bold text-gray-400 mt-4 italic"></p>
            </div>
        </div>

        <div class="mt-8 p-4 bg-slate-800 rounded-xl text-[10px] font-mono text-slate-400 overflow-auto max-h-32 shadow-inner">
            <div id="diagnosticLog">Waiting for System Start...</div>
        </div>
        <div class="mt-4 text-center"><button id="syncButton" class="text-xs text-blue-500 underline uppercase italic">Force Refresh</button></div>
    </div>

    <script>
        // â˜…ã“ã“ã«ã€Œãƒ†ã‚¹ãƒˆæˆåŠŸã—ãŸURLã€ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„â˜…
        const API_URL = 'https://script.google.com/macros/s/AKfycbwXtPmOOFMOnKsywVLqdL6uBKC24ApA7cZBJgB_m4IjioWiEfIQiWomAuKsfnFHpe4/exec';
        
        const appState = {
            currentYear: new Date().getFullYear(),
            currentMonth: new Date().getMonth() + 1,
            carryOver: { user1: 0, user2: 0 },
            expenses: { user1: [], user2: [] },
            refundAmounts: { user1: 0, user2: 0 },
            settlementDate: null,
            regularConfig: {
                user1: [{ label: 'é›»æ°—', keyword: 'é›»æ°—' }, { label: 'æ°´é“', keyword: 'æ°´é“' }, { label: 'ã‚¬ã‚¹', keyword: 'ã‚¬ã‚¹' }],
                user2: [{ label: 'ã‚¬ã‚½ãƒªãƒ³', keyword: 'ã‚¬ã‚½ãƒªãƒ³' }]
            }
        };

        function logDiag(msg) {
            const div = document.getElementById('diagnosticLog');
            if (div) div.innerHTML = `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>` + div.innerHTML;
        }

        function formatCurrency(v) { return Math.floor(v || 0).toLocaleString() + 'å††'; }
        function debounce(f, w) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => f(...a), w); }; }

        async function callAPI(action, params = {}) {
            logDiag(`Calling API: ${action}...`);
            return new Promise((resolve, reject) => {
                const cb = 'cb_' + Math.random().toString(36).substr(2, 9);
                window[cb] = (d) => {
                    logDiag(`Success: Received ${action}`);
                    delete window[cb];
                    const scriptTag = document.getElementById(cb);
                    if (scriptTag) document.body.removeChild(scriptTag);
                    if (d && d.success) resolve(d); else reject(new Error(d.error || 'API Error'));
                };
                const s = document.createElement('script');
                s.id = cb;
                const query = new URLSearchParams({ action, callback: cb, ...params, _t: Date.now() }).toString();
                s.src = `${API_URL}${API_URL.includes('?') ? '&' : '?'}${query}`;
                s.onerror = () => { logDiag(`Error: Network Connection Failed`); reject(new Error('Network error')); };
                document.body.appendChild(s);
                setTimeout(() => { if (window[cb]) { logDiag(`Error: API Timeout`); reject(new Error('Timeout')); } }, 15000);
            });
        }

        async function loadData() {
            const status = document.getElementById('settlementStatus');
            status.textContent = "âŒ› Loading Data...";
            try {
                const res = await callAPI('getBatchData', { year: appState.currentYear, month: appState.currentMonth });
                appState.expenses = res.expenses || { user1: [], user2: [] };
                appState.carryOver = res.carryOver || { user1: 0, user2: 0 };
                appState.refundAmounts = res.refundAmounts || { user1: 0, user2: 0 };
                appState.settlementDate = res.settlementDate;
                updateUI();
                status.textContent = appState.settlementDate ? `âœ… ç²¾ç®—æ¸ˆã¿: ${appState.settlementDate}` : "Status: Open (Sync OK)";
            } catch (e) {
                status.textContent = "âŒ Sync Failed";
                logDiag(`Critical Error: ${e.message}`);
            }
        }

        function updateUI() {
            document.getElementById('currentMonthDisplay').textContent = `${appState.currentYear}å¹´${appState.currentMonth}æœˆ`;
            ['user1', 'user2'].forEach(u => {
                const items = appState.expenses[u] || [];
                const container = document.getElementById(`${u}-expenses`);
                container.innerHTML = items.length ? items.map(ex => `
                    <tr class="border-b"><td class="p-2 text-xs text-gray-400 font-bold">${ex.date}æ—¥</td><td class="p-2 font-medium">${ex.description}</td><td class="p-2 text-right font-bold font-mono">${parseFloat(ex.amount).toLocaleString()}</td><td class="p-2 text-right w-8"><button onclick="deleteExpense('${u}','${ex.id}')" class="text-red-300 hover:text-red-500">âœ•</button></td></tr>`).join('') : '<tr><td class="p-4 text-center text-gray-300 italic font-medium text-xs">No records this month</td></tr>';
                
                document.getElementById(`${u}-regular-list`).innerHTML = appState.regularConfig[u].map(item => {
                    const ok = items.some(ex => ex.description && ex.description.includes(item.keyword));
                    return `<span class="px-1.5 py-0.5 rounded text-[9px] font-black border ${ok?'bg-green-500 text-white border-green-500':'bg-gray-100 text-gray-300 border-gray-200'}">${item.label}</span>`;
                }).join('');

                const cur = items.reduce((s, e) => s + parseFloat(e.amount || 0), 0);
                const carry = parseFloat(appState.carryOver[u] || 0);
                const total = cur + carry;
                const refund = parseFloat(appState.refundAmounts[u] || 0);

                document.getElementById(`${u}-carryover`).textContent = formatCurrency(carry);
                document.getElementById(`${u}-current`).textContent = formatCurrency(cur);
                document.getElementById(`${u}-total`).textContent = formatCurrency(total);
                document.getElementById(`${u}-settlement-total`).textContent = formatCurrency(total);
                
                const rInput = document.getElementById(`${u}-refund`);
                if (document.activeElement !== rInput) rInput.value = refund;
                document.getElementById(`${u}-next-carryover`).textContent = formatCurrency(total - refund);
            });
        }

        const autoSave = debounce(async (u, v) => {
            const val = parseFloat(v) || 0;
            appState.refundAmounts[u] = val;
            updateUI();
            try { await callAPI('saveCarryOver', { data: JSON.stringify({ userId: u, year: appState.currentYear, month: appState.currentMonth, amount: appState.carryOver[u], refund: val }) }); } catch(e){}
        }, 1000);

        document.getElementById('user1-refund').oninput = (e) => autoSave('user1', e.target.value);
        document.getElementById('user2-refund').oninput = (e) => autoSave('user2', e.target.value);

        document.getElementById('settlementButton').onclick = async () => {
            if (!confirm('ç²¾ç®—ã‚’ç¢ºå®šã—ã¾ã™ã‹ï¼Ÿ')) return;
            try {
                for (const u of ['user1', 'user2']) {
                    const items = appState.expenses[u] || [];
                    const curTotal = items.reduce((s,e)=>s+parseFloat(e.amount||0),0) + parseFloat(appState.carryOver[u]||0);
                    const refund = parseFloat(appState.refundAmounts[u]||0);
                    await callAPI('settlement', { data: JSON.stringify({ userId: u, year: appState.currentYear, month: appState.currentMonth, currentTotal: curTotal, refund: refund, nextCarryOver: curTotal - refund, settlementDate: new Date().toLocaleString('ja-JP', {dateStyle:'medium', timeStyle:'short'}) }) });
                }
                alert('ç²¾ç®—å®Œäº†ã€‚ç¿Œæœˆã¸ç§»å‹•ã—ã¾ã™ã€‚');
                changeMonth(1);
            } catch (e) { alert('ç²¾ç®—ã‚¨ãƒ©ãƒ¼: ' + e.message); }
        };

        document.getElementById('expenseForm').onsubmit = async (e) => {
            e.preventDefault();
            const d = { userId: document.getElementById('userSelect').value, date: document.getElementById('dateInput').value, description: document.getElementById('descriptionInput').value, amount: parseFloat(document.getElementById('amountInput').value), year: appState.currentYear, month: appState.currentMonth };
            if (!d.date || !d.description || isNaN(d.amount)) return;
            const btn = document.getElementById('submitButton');
            btn.disabled = true;
            try { 
                await callAPI('saveExpense', { data: JSON.stringify(d) }); 
                document.getElementById('expenseForm').reset(); 
                await loadData(); 
            } finally { 
                btn.disabled = false; 
            }
        };

        window.deleteExpense = async (u, id) => { if (confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { await callAPI('deleteExpense', { id }); await loadData(); } };
        
        function changeMonth(dir) {
            appState.currentMonth += dir;
            if (appState.currentMonth > 12) { appState.currentMonth = 1; appState.currentYear++; }
            if (appState.currentMonth < 1) { appState.currentMonth = 12; appState.currentYear--; }
            loadData();
        }
        document.getElementById('prevMonth').onclick = () => changeMonth(-1);
        document.getElementById('nextMonth').onclick = () => changeMonth(1);
        document.getElementById('syncButton').onclick = () => loadData();

        logDiag("System Initialized.");
        loadData();
    </script>
</body>
</html>
