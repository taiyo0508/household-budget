<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>家計簿アプリ - 完結版修正</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .negative-amount { color: #ef4444; }
        input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen pb-10">
    <div id="app" class="max-w-6xl mx-auto p-4">
        <h1 class="text-3xl font-bold text-center my-4 text-gray-800">家計簿アプリ</h1>
        
        <div class="bg-white p-4 rounded-lg shadow mb-6 flex justify-between items-center border-b-4 border-blue-500">
            <button id="prevMonth" class="px-6 py-2 bg-blue-500 text-white rounded shadow hover:bg-blue-600 transition-colors">前月</button>
            <h2 id="currentMonthDisplay" class="text-2xl font-bold text-gray-700">2026年1月</h2>
            <button id="nextMonth" class="px-6 py-2 bg-blue-500 text-white rounded shadow hover:bg-blue-600 transition-colors">次月</button>
        </div>
        
        <div class="bg-white p-6 rounded-lg shadow mb-6 border-l-8 border-green-500">
            <form id="expenseForm" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <select id="userSelect" class="p-2 border rounded font-bold"><option value="user1">太陽</option><option value="user2">愛華音</option></select>
                <input id="dateInput" type="number" placeholder="日" class="p-2 border rounded" />
                <input id="descriptionInput" type="text" placeholder="内容" class="p-2 border rounded" />
                <div class="flex gap-2">
                    <input id="amountInput" type="number" placeholder="金額" class="p-2 border rounded flex-1" />
                    <button id="submitButton" type="submit" class="px-4 py-2 bg-green-500 text-white font-bold rounded">追加</button>
                </div>
            </form>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-lg shadow border-t-4 border-yellow-400">
                <h3 class="text-xl font-bold mb-4 text-yellow-600">太陽</h3>
                <div class="mb-4 p-3 bg-gray-50 rounded text-sm space-y-1">
                    <p class="flex justify-between"><span>前月持越し:</span> <span id="user1-carryover" class="font-bold">0円</span></p>
                    <p class="flex justify-between text-blue-600"><span>当月合計:</span> <span id="user1-current">0円</span></p>
                    <p class="flex justify-between border-t pt-1 font-bold text-lg"><span>総合計:</span> <span id="user1-total">0円</span></p>
                </div>
                <div class="mt-4"><div id="user1-regular-list" class="flex flex-wrap gap-2 mb-4"></div></div>
                <table class="w-full text-sm"><tbody id="user1-expenses"></tbody></table>
            </div>
            <div class="bg-white p-6 rounded-lg shadow border-t-4 border-blue-400">
                <h3 class="text-xl font-bold mb-4 text-blue-600">愛華音</h3>
                <div class="mb-4 p-3 bg-gray-50 rounded text-sm space-y-1">
                    <p class="flex justify-between"><span>前月持越し:</span> <span id="user2-carryover" class="font-bold">0円</span></p>
                    <p class="flex justify-between text-blue-600"><span>当月合計:</span> <span id="user2-current">0円</span></p>
                    <p class="flex justify-between border-t pt-1 font-bold text-lg"><span>総合計:</span> <span id="user2-total">0円</span></p>
                </div>
                <div class="mt-4"><div id="user2-regular-list" class="flex flex-wrap gap-2 mb-4"></div></div>
                <table class="w-full text-sm"><tbody id="user2-expenses"></tbody></table>
            </div>
        </div>

        <div class="mt-8 bg-white p-6 rounded-lg shadow border-2 border-purple-200">
            <h3 class="text-2xl font-bold mb-4 text-purple-700">月末清算</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                <div class="p-5 rounded-xl border-2 border-yellow-300 bg-yellow-50">
                    <h4 class="font-bold mb-3">太陽 の精算</h4>
                    <div class="space-y-2">
                        <div class="flex justify-between"><span>総合計:</span><span id="user1-settlement-total" class="font-bold">0円</span></div>
                        <div class="flex justify-between items-center text-red-600"><span>返金額:</span><input id="user1-refund" type="number" class="w-32 p-2 border-2 border-yellow-400 rounded text-right font-bold" /></div>
                        <div class="flex justify-between pt-2 border-t font-black text-lg"><span>翌月持越:</span><span id="user1-next-carryover">0円</span></div>
                    </div>
                </div>
                <div class="p-5 rounded-xl border-2 border-blue-300 bg-blue-50">
                    <h4 class="font-bold mb-3">愛華音 の精算</h4>
                    <div class="space-y-2">
                        <div class="flex justify-between"><span>総合計:</span><span id="user2-settlement-total" class="font-bold">0円</span></div>
                        <div class="flex justify-between items-center text-red-600"><span>返金額:</span><input id="user2-refund" type="number" class="w-32 p-2 border-2 border-blue-400 rounded text-right font-bold" /></div>
                        <div class="flex justify-between pt-2 border-t font-black text-lg"><span>翌月持越:</span><span id="user2-next-carryover">0円</span></div>
                    </div>
                </div>
            </div>
            <div class="flex flex-col items-center">
                <button id="settlementButton" class="px-10 py-4 bg-purple-600 text-white rounded-full font-black text-xl shadow-lg hover:bg-purple-700">精算を確定して翌月へ</button>
                <p id="settlementStatus" class="text-xs text-gray-400 mt-4"></p>
            </div>
        </div>
        <div class="mt-4 text-center"><button id="syncButton" class="text-[10px] text-gray-400 underline">データを強制更新</button></div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbxuxXGY5wKvdwG4yLqcdnOFdyKJCNZFia4caLxHqRAodrUrinICcAIcmjjolILEtCkv/exec';
        const appState = {
            currentYear: new Date().getFullYear(),
            currentMonth: new Date().getMonth() + 1,
            carryOver: { user1: 0, user2: 0 },
            expenses: { user1: [], user2: [] },
            refundAmounts: { user1: 0, user2: 0 },
            settlementDate: null,
            regularConfig: {
                user1: [{ label: '電気代', keyword: '電気' }, { label: '水道代', keyword: '水道' }, { label: 'ガス代', keyword: 'ガス' }],
                user2: [{ label: 'ガソリン代', keyword: 'ガソリン' }]
            }
        };

        async function callAPI(action, params = {}) {
            return new Promise((resolve, reject) => {
                const cb = 'cb_' + Math.random().toString(36).substr(2, 9);
                window[cb] = (d) => { delete window[cb]; document.body.removeChild(s); if (d && d.success) resolve(d); else reject(new Error(d.error)); };
                const s = document.createElement('script');
                s.src = `${API_URL}?${new URLSearchParams({ action, callback: cb, ...params }).toString()}`;
                document.body.appendChild(s);
            });
        }

        async function loadData() {
            document.getElementById('settlementStatus').textContent = "同期中...";
            try {
                const res = await callAPI('getBatchData', { year: appState.currentYear, month: appState.currentMonth });
                appState.expenses = res.expenses;
                appState.carryOver = res.carryOver;
                appState.refundAmounts = res.refundAmounts;
                appState.settlementDate = res.settlementDate;
                updateUI();
                document.getElementById('settlementStatus').textContent = appState.settlementDate ? `精算済み: ${appState.settlementDate}` : "";
            } catch (e) { console.error(e); }
        }

        function updateUI() {
            document.getElementById('currentMonthDisplay').textContent = `${appState.currentYear}年${appState.currentMonth}月`;
            ['user1', 'user2'].forEach(u => {
                const container = document.getElementById(`${u}-expenses`);
                container.innerHTML = appState.expenses[u].map(ex => `<tr class="border-b"><td class="p-2 text-xs text-gray-400">${ex.date}日</td><td class="p-2">${ex.description}</td><td class="p-2 text-right font-bold">${parseFloat(ex.amount).toLocaleString()}</td><td class="p-2 text-right"><button onclick="deleteExpense('${u}','${ex.id}')" class="text-red-300">✕</button></td></tr>`).join('');
                
                const list = document.getElementById(`${u}-regular-list`);
                list.innerHTML = appState.regularConfig[u].map(item => {
                    const ok = appState.expenses[u].some(ex => ex.description.includes(item.keyword));
                    return `<span class="px-2 py-1 rounded text-[10px] font-bold border ${ok?'bg-green-100 text-green-700 border-green-300':'bg-red-50 text-red-300 border-red-200'}">${ok?'✓':'○'} ${item.label}</span>`;
                }).join('');

                const cur = appState.expenses[u].reduce((s, e) => s + parseFloat(e.amount), 0);
                const total = cur + appState.carryOver[u];
                document.getElementById(`${u}-carryover`).textContent = appState.carryOver[u].toLocaleString() + '円';
                document.getElementById(`${u}-current`).textContent = cur.toLocaleString() + '円';
                document.getElementById(`${u}-total`).textContent = total.toLocaleString() + '円';
                document.getElementById(`${u}-settlement-total`).textContent = total.toLocaleString() + '円';
                
                // ★ここを修正：値が0でも正しく表示するように
                document.getElementById(`${u}-refund`).value = appState.refundAmounts[u];
                document.getElementById(`${u}-next-carryover`).textContent = (total - appState.refundAmounts[u]).toLocaleString() + '円';
            });
        }

        function debounce(f, w) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => f(...a), w); }; }

        const autoSave = debounce(async (u, v) => {
            const val = parseFloat(v) || 0;
            appState.refundAmounts[u] = val;
            updateUI();
            await callAPI('saveCarryOver', { data: JSON.stringify({ userId: u, year: appState.currentYear, month: appState.currentMonth, amount: appState.carryOver[u], refund: val }) });
        }, 800);

        document.getElementById('user1-refund').oninput = (e) => autoSave('user1', e.target.value);
        document.getElementById('user2-refund').oninput = (e) => autoSave('user2', e.target.value);

        document.getElementById('settlementButton').onclick = async () => {
            if (!confirm('精算を確定しますか？')) return;
            for (const u of ['user1', 'user2']) {
                const total = appState.expenses[u].reduce((s, e) => s + parseFloat(e.amount), 0) + appState.carryOver[u];
                await callAPI('settlement', { data: JSON.stringify({ userId: u, year: appState.currentYear, month: appState.currentMonth, currentTotal: total, refund: appState.refundAmounts[u], nextCarryOver: total - appState.refundAmounts[u], settlementDate: new Date().toLocaleString('ja-JP') }) });
            }
            alert('精算完了');
            appState.currentMonth++;
            if (appState.currentMonth > 12) { appState.currentMonth = 1; appState.currentYear++; }
            loadData();
        };

        document.getElementById('expenseForm').onsubmit = async (e) => {
            e.preventDefault();
            const d = { userId: document.getElementById('userSelect').value, date: document.getElementById('dateInput').value, description: document.getElementById('descriptionInput').value, amount: parseFloat(document.getElementById('amountInput').value), year: appState.currentYear, month: appState.currentMonth };
            await callAPI('saveExpense', { data: JSON.stringify(d) });
            document.getElementById('expenseForm').reset();
            loadData();
        };

        window.deleteExpense = async (u, id) => { if (confirm('削除？')) { await callAPI('deleteExpense', { id }); loadData(); } };
        
        function changeMonth(dir) {
            appState.currentMonth += dir;
            if (appState.currentMonth > 12) { appState.currentMonth = 1; appState.currentYear++; }
            if (appState.currentMonth < 1) { appState.currentMonth = 12; appState.currentYear--; }
            loadData();
        }
        document.getElementById('prevMonth').onclick = () => changeMonth(-1);
        document.getElementById('nextMonth').onclick = () => changeMonth(1);
        document.getElementById('syncButton').onclick = () => loadData();

        loadData();
    </script>
</body>
</html>
