<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶è¨ˆç°¿ã‚¢ãƒ—ãƒª - å®‰å®šç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .negative-amount { color: #ef4444; }
        input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen pb-10 text-gray-800">
    <div id="app" class="max-w-6xl mx-auto p-4">
        <h1 class="text-3xl font-bold text-center my-6">å®¶è¨ˆç°¿ã‚¢ãƒ—ãƒª</h1>
        
        <div class="bg-white p-4 rounded-xl shadow mb-6 flex justify-between items-center border-b-4 border-blue-500">
            <button id="prevMonth" class="px-6 py-2 bg-blue-500 text-white rounded-lg shadow hover:bg-blue-600">å‰æœˆ</button>
            <h2 id="currentMonthDisplay" class="text-2xl font-bold">èª­ã¿è¾¼ã¿ä¸­...</h2>
            <button id="nextMonth" class="px-6 py-2 bg-blue-500 text-white rounded-lg shadow hover:bg-blue-600">æ¬¡æœˆ</button>
        </div>
        
        <div class="bg-white p-6 rounded-xl shadow mb-6 border-l-8 border-green-500">
            <form id="expenseForm" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <select id="userSelect" class="p-3 border rounded-lg font-bold"><option value="user1">å¤ªé™½</option><option value="user2">æ„›è¯éŸ³</option></select>
                <input id="dateInput" type="number" placeholder="æ—¥" class="p-3 border rounded-lg" />
                <input id="descriptionInput" type="text" placeholder="å†…å®¹ï¼ˆä¾‹ï¼šé›»æ°—ï¼‰" class="p-3 border rounded-lg" />
                <div class="flex gap-2">
                    <input id="amountInput" type="number" placeholder="é‡‘é¡" class="p-3 border rounded-lg flex-1 font-mono" />
                    <button id="submitButton" type="submit" class="px-6 py-3 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600 active:scale-95">è¿½åŠ </button>
                </div>
            </form>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-xl shadow border-t-4 border-yellow-400">
                <div class="flex justify-between items-center mb-4 text-yellow-600"><h3 class="text-xl font-bold">å¤ªé™½</h3><div id="user1-regular-list" class="flex flex-wrap gap-1"></div></div>
                <div class="mb-4 p-3 bg-gray-50 rounded-lg text-sm space-y-1">
                    <p class="flex justify-between font-medium"><span>å‰æœˆæŒè¶Šã—:</span> <span id="user1-carryover">0å††</span></p>
                    <p class="flex justify-between text-blue-600"><span>å½“æœˆåˆè¨ˆ:</span> <span id="user1-current">0å††</span></p>
                    <p class="flex justify-between border-t pt-1 font-bold text-lg"><span>ç·åˆè¨ˆ:</span> <span id="user1-total">0å††</span></p>
                </div>
                <table class="w-full text-sm"><tbody id="user1-expenses"></tbody></table>
            </div>
            <div class="bg-white p-6 rounded-xl shadow border-t-4 border-blue-400">
                <div class="flex justify-between items-center mb-4 text-blue-600"><h3 class="text-xl font-bold">æ„›è¯éŸ³</h3><div id="user2-regular-list" class="flex flex-wrap gap-1"></div></div>
                <div class="mb-4 p-3 bg-gray-50 rounded-lg text-sm space-y-1">
                    <p class="flex justify-between font-medium"><span>å‰æœˆæŒè¶Šã—:</span> <span id="user2-carryover">0å††</span></p>
                    <p class="flex justify-between text-blue-600"><span>å½“æœˆåˆè¨ˆ:</span> <span id="user2-current">0å††</span></p>
                    <p class="flex justify-between border-t pt-1 font-bold text-lg"><span>ç·åˆè¨ˆ:</span> <span id="user2-total">0å††</span></p>
                </div>
                <table class="w-full text-sm"><tbody id="user2-expenses"></tbody></table>
            </div>
        </div>

        <div class="mt-8 bg-white p-6 rounded-xl shadow border-2 border-purple-300">
            <h3 class="text-2xl font-bold mb-6 text-purple-700 flex items-center gap-2">ğŸ’³ æœˆæœ«æ¸…ç®—</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                <div class="p-5 rounded-2xl border-2 border-yellow-300 bg-yellow-50">
                    <h4 class="font-bold mb-3">å¤ªé™½ ã®ç²¾ç®—</h4>
                    <div class="space-y-3 font-medium">
                        <div class="flex justify-between text-gray-600"><span>ç¾åœ¨ã®åˆè¨ˆ:</span><span id="user1-settlement-total">0å††</span></div>
                        <div class="flex justify-between items-center text-red-600"><span>è¿”é‡‘é¡ï¼ˆè‡ªå‹•ä¿å­˜ï¼‰:</span><input id="user1-refund" type="number" class="w-32 p-2 border-2 border-yellow-400 rounded-lg text-right font-bold focus:bg-white" /></div>
                        <div class="flex justify-between pt-3 border-t-2 border-yellow-200 font-bold"><span>ç¿ŒæœˆæŒè¶Šé¡:</span><span id="user1-next-carryover" class="text-2xl text-yellow-900 underline">0å††</span></div>
                    </div>
                </div>
                <div class="p-5 rounded-2xl border-2 border-blue-300 bg-blue-50">
                    <h4 class="font-bold mb-3">æ„›è¯éŸ³ ã®ç²¾ç®—</h4>
                    <div class="space-y-3 font-medium">
                        <div class="flex justify-between text-gray-600"><span>ç¾åœ¨ã®åˆè¨ˆ:</span><span id="user2-settlement-total">0å††</span></div>
                        <div class="flex justify-between items-center text-red-600"><span>è¿”é‡‘é¡ï¼ˆè‡ªå‹•ä¿å­˜ï¼‰:</span><input id="user2-refund" type="number" class="w-32 p-2 border-2 border-blue-400 rounded-lg text-right font-bold focus:bg-white" /></div>
                        <div class="flex justify-between pt-3 border-t-2 border-blue-200 font-bold"><span>ç¿ŒæœˆæŒè¶Šé¡:</span><span id="user2-next-carryover" class="text-2xl text-blue-900 underline">0å††</span></div>
                    </div>
                </div>
            </div>
            <div class="flex flex-col items-center gap-4">
                <button id="settlementButton" class="px-12 py-4 bg-purple-600 text-white rounded-full font-black text-xl shadow-lg hover:bg-purple-700 active:scale-95">ç²¾ç®—ã‚’ç¢ºå®šã—ã¦ç¿Œæœˆã¸</button>
                <p id="settlementStatus" class="text-sm font-bold text-gray-400 italic"></p>
            </div>
        </div>
        <div class="mt-8 text-center"><button id="syncButton" class="text-xs text-gray-400 underline italic">Force Refresh Data</button></div>
    </div>

    <script>
        // â˜… ã“ã“ã«è‡ªåˆ†ã®GAS URLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ â˜…
        const API_URL = 'https://script.google.com/macros/s/AKfycbwXtPmOOFMOnKsywVLqdL6uBKC24ApA7cZBJgB_m4IjioWiEfIQiWomAuKsfnFHpe4/exec';
        
        const appState = {
            currentYear: new Date().getFullYear(),
            currentMonth: new Date().getMonth() + 1,
            carryOver: { user1: 0, user2: 0 },
            expenses: { user1: [], user2: [] },
            refundAmounts: { user1: 0, user2: 0 },
            settlementDate: null,
            regularConfig: {
                user1: [{ label: 'é›»æ°—', keyword: 'é›»æ°—' }, { label: 'æ°´é“', keyword: 'æ°´é“' }, { label: 'ã‚¬ã‚¹', keyword: 'ã‚¬ã‚¹' }],
                user2: [{ label: 'ã‚¬ã‚½ãƒªãƒ³', keyword: 'ã‚¬ã‚½ãƒªãƒ³' }]
            }
        };

        function formatCurrency(v) { return Math.floor(v).toLocaleString() + 'å††'; }
        function debounce(f, w) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => f(...a), w); }; }

        async function callAPI(action, params = {}) {
            return new Promise((resolve, reject) => {
                const cb = 'cb_' + Math.random().toString(36).substr(2, 9);
                window[cb] = (d) => { delete window[cb]; document.body.removeChild(s); if (d && d.success) resolve(d); else reject(new Error(d.error)); };
                const s = document.createElement('script');
                s.src = `${API_URL}?${new URLSearchParams({ action, callback: cb, ...params }).toString()}`;
                document.body.appendChild(s);
                setTimeout(() => { if (window[cb]) reject(new Error('Timeout')); }, 15000);
            });
        }

        async function loadData() {
            document.getElementById('settlementStatus').textContent = "Syncing with cloud...";
            try {
                const res = await callAPI('getBatchData', { year: appState.currentYear, month: appState.currentMonth });
                appState.expenses = res.expenses;
                appState.carryOver = res.carryOver;
                appState.refundAmounts = res.refundAmounts;
                appState.settlementDate = res.settlementDate;
                updateUI();
                document.getElementById('settlementStatus').textContent = appState.settlementDate ? `Closed on: ${appState.settlementDate}` : "Status: Open";
            } catch (e) { document.getElementById('settlementStatus').textContent = "Sync Failed. Check API URL."; }
        }

        function updateUI() {
            document.getElementById('currentMonthDisplay').textContent = `${appState.currentYear}å¹´${appState.currentMonth}æœˆ`;
            ['user1', 'user2'].forEach(u => {
                const container = document.getElementById(`${u}-expenses`);
                container.innerHTML = appState.expenses[u].map(ex => `<tr class="border-b"><td class="p-2 text-xs text-gray-400 font-bold">${ex.date}æ—¥</td><td class="p-2 font-medium">${ex.description}</td><td class="p-2 text-right font-bold">${parseFloat(ex.amount).toLocaleString()}</td><td class="p-2 text-right"><button onclick="deleteExpense('${u}','${ex.id}')" class="text-red-300 hover:text-red-600">âœ•</button></td></tr>`).join('');
                
                const list = document.getElementById(`${u}-regular-list`);
                list.innerHTML = appState.regularConfig[u].map(item => {
                    const ok = appState.expenses[u].some(ex => ex.description && ex.description.includes(item.keyword));
                    return `<span class="px-2 py-0.5 rounded text-[10px] font-black border ${ok?'bg-green-500 text-white border-green-500':'bg-gray-100 text-gray-300 border-gray-200'}">${item.label}</span>`;
                }).join('');

                const cur = appState.expenses[u].reduce((s, e) => s + parseFloat(e.amount || 0), 0);
                const total = cur + appState.carryOver[u];
                document.getElementById(`${u}-carryover`).textContent = formatCurrency(appState.carryOver[u]);
                document.getElementById(`${u}-current`).textContent = formatCurrency(cur);
                document.getElementById(`${u}-total`).textContent = formatCurrency(total);
                document.getElementById(`${u}-settlement-total`).textContent = formatCurrency(total);
                
                const ref = appState.refundAmounts[u];
                document.getElementById(`${u}-refund`).value = (ref === undefined || ref === null) ? 0 : ref;
                document.getElementById(`${u}-next-carryover`).textContent = formatCurrency(total - ref);
            });
        }

        const autoSave = debounce(async (u, v) => {
            const val = parseFloat(v) || 0;
            appState.refundAmounts[u] = val;
            updateUI();
            try { await callAPI('saveCarryOver', { data: JSON.stringify({ userId: u, year: appState.currentYear, month: appState.currentMonth, amount: appState.carryOver[u], refund: val }) }); } catch(e){}
        }, 800);

        document.getElementById('user1-refund').oninput = (e) => autoSave('user1', e.target.value);
        document.getElementById('user2-refund').oninput = (e) => autoSave('user2', e.target.value);

        document.getElementById('settlementButton').onclick = async () => {
            if (!confirm('ç²¾ç®—ã‚’ç¢ºå®šã—ã¾ã™ã‹ï¼Ÿ')) return;
            try {
                for (const u of ['user1', 'user2']) {
                    const curTotal = appState.expenses[u].reduce((s, e) => s + parseFloat(e.amount || 0), 0) + appState.carryOver[u];
                    await callAPI('settlement', { data: JSON.stringify({ userId: u, year: appState.currentYear, month: appState.currentMonth, currentTotal: curTotal, refund: appState.refundAmounts[u], nextCarryOver: curTotal - appState.refundAmounts[u], settlementDate: new Date().toLocaleString('ja-JP') }) });
                }
                alert('ç²¾ç®—å®Œäº†ã€‚ç¿Œæœˆã¸ç§»å‹•ã—ã¾ã™ã€‚');
                changeMonth(1);
            } catch (e) { alert('ç²¾ç®—ã‚¨ãƒ©ãƒ¼'); }
        };

        elements.expenseForm.onsubmit = async (e) => {
            e.preventDefault();
            const d = { userId: document.getElementById('userSelect').value, date: document.getElementById('dateInput').value, description: document.getElementById('descriptionInput').value, amount: parseFloat(document.getElementById('amountInput').value), year: appState.currentYear, month: appState.currentMonth };
            if (!d.date || !d.description || isNaN(d.amount)) return alert('å…¥åŠ›ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
            elements.submitButton.disabled = true;
            try { await callAPI('saveExpense', { data: JSON.stringify(d) }); elements.expenseForm.reset(); loadData(); } catch (err) { alert('ä¿å­˜å¤±æ•—'); }
            finally { elements.submitButton.disabled = false; }
        };

        window.deleteExpense = async (userId, id) => { if (confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { await callAPI('deleteExpense', { id }); loadData(); } };
        
        function changeMonth(dir) {
            appState.currentMonth += dir;
            if (appState.currentMonth > 12) { appState.currentMonth = 1; appState.currentYear++; }
            if (appState.currentMonth < 1) { appState.currentMonth = 12; appState.currentYear--; }
            loadData();
        }
        document.getElementById('prevMonth').onclick = () => changeMonth(-1);
        document.getElementById('nextMonth').onclick = () => changeMonth(1);
        document.getElementById('syncButton').onclick = () => loadData();

        loadData();
    </script>
</body>
</html>
