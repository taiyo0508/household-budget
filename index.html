<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶è¨ˆç°¿ã‚¢ãƒ—ãƒª - å®šæœŸæ”¯å‡ºåˆ¤å®šç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .negative-amount { color: #ef4444; }
        input[type="number"]::-webkit-inner-spin-button, 
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app" class="max-w-6xl mx-auto p-4">
        <h1 class="text-3xl font-bold text-center my-4 text-gray-800">å®¶è¨ˆç°¿ã‚¢ãƒ—ãƒª</h1>
        
        <div class="bg-white p-4 rounded-lg shadow mb-6 flex justify-between items-center border-b-4 border-blue-500">
            <button id="prevMonth" class="px-6 py-2 bg-blue-500 text-white rounded shadow hover:bg-blue-600 transition-colors">å‰æœˆ</button>
            <h2 id="currentMonthDisplay" class="text-2xl font-bold text-gray-700">2026å¹´1æœˆ</h2>
            <button id="nextMonth" class="px-6 py-2 bg-blue-500 text-white rounded shadow hover:bg-blue-600 transition-colors">æ¬¡æœˆ</button>
        </div>
        
        <div class="bg-white p-6 rounded-lg shadow mb-6 border-l-8 border-green-500">
            <h3 id="formTitle" class="text-xl font-semibold mb-4 text-gray-700">æ–°è¦æ”¯å‡ºã®è¿½åŠ </h3>
            <form id="expenseForm">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">ãƒ¦ãƒ¼ã‚¶ãƒ¼</label>
                        <select id="userSelect" class="w-full p-2 border rounded focus:ring-2 focus:ring-green-400 outline-none">
                            <option value="user1">å¤ªé™½</option>
                            <option value="user2">æ„›è¯éŸ³</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">æ—¥ä»˜</label>
                        <input id="dateInput" type="number" placeholder="ä¾‹: 15" class="w-full p-2 border rounded focus:ring-2 focus:ring-green-400 outline-none" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">å†…å®¹</label>
                        <input id="descriptionInput" type="text" placeholder="ä¾‹: é›»æ°—" class="w-full p-2 border rounded focus:ring-2 focus:ring-green-400 outline-none" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">é‡‘é¡</label>
                        <input id="amountInput" type="number" placeholder="ä¾‹: 1200" class="w-full p-2 border rounded focus:ring-2 focus:ring-green-400 outline-none" />
                    </div>
                </div>
                <div class="mt-4 flex justify-end">
                    <button id="submitButton" type="submit" class="px-6 py-2 bg-green-500 text-white font-bold rounded hover:bg-green-600 transition-colors">è¿½åŠ </button>
                </div>
            </form>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-lg shadow border-t-4 border-yellow-400">
                <h3 class="text-xl font-bold mb-4 text-yellow-600">å¤ªé™½</h3>
                <div class="mb-4 p-3 bg-gray-50 rounded text-sm grid grid-cols-1 gap-1">
                    <p class="flex justify-between"><span>å‰æœˆæŒè¶Šã—:</span> <span id="user1-carryover" class="font-bold">0å††</span></p>
                    <p class="flex justify-between text-blue-600 font-medium"><span>å½“æœˆæ”¯å‡ºåˆè¨ˆ:</span> <span id="user1-current">0å††</span></p>
                    <p class="flex justify-between border-t pt-1 text-lg font-bold text-gray-800"><span>ç·åˆè¨ˆ:</span> <span id="user1-total">0å††</span></p>
                </div>
                <div class="overflow-x-auto min-h-[150px]">
                    <table class="min-w-full text-sm">
                        <thead class="bg-gray-100"><tr><th class="p-2 text-left">æ—¥</th><th class="p-2 text-left">å†…å®¹</th><th class="p-2 text-right">é‡‘é¡</th><th class="p-2 text-center">æ“ä½œ</th></tr></thead>
                        <tbody id="user1-expenses"></tbody>
                    </table>
                </div>
                <div class="mt-4 pt-4 border-t border-dashed border-gray-200">
                    <h4 class="text-xs font-bold text-gray-400 mb-2 uppercase tracking-widest">å®šæœŸæ”¯å‡ºãƒã‚§ãƒƒã‚¯</h4>
                    <div id="user1-regular-list" class="flex flex-wrap gap-2"></div>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow border-t-4 border-blue-400">
                <h3 class="text-xl font-bold mb-4 text-blue-600">æ„›è¯éŸ³</h3>
                <div class="mb-4 p-3 bg-gray-50 rounded text-sm grid grid-cols-1 gap-1">
                    <p class="flex justify-between"><span>å‰æœˆæŒè¶Šã—:</span> <span id="user2-carryover" class="font-bold">0å††</span></p>
                    <p class="flex justify-between text-blue-600 font-medium"><span>å½“æœˆæ”¯å‡ºåˆè¨ˆ:</span> <span id="user2-current">0å††</span></p>
                    <p class="flex justify-between border-t pt-1 text-lg font-bold text-gray-800"><span>ç·åˆè¨ˆ:</span> <span id="user2-total">0å††</span></p>
                </div>
                <div class="overflow-x-auto min-h-[150px]">
                    <table class="min-w-full text-sm">
                        <thead class="bg-gray-100"><tr><th class="p-2 text-left">æ—¥</th><th class="p-2 text-left">å†…å®¹</th><th class="p-2 text-right">é‡‘é¡</th><th class="p-2 text-center">æ“ä½œ</th></tr></thead>
                        <tbody id="user2-expenses"></tbody>
                    </table>
                </div>
                <div class="mt-4 pt-4 border-t border-dashed border-gray-200">
                    <h4 class="text-xs font-bold text-gray-400 mb-2 uppercase tracking-widest">å®šæœŸæ”¯å‡ºãƒã‚§ãƒƒã‚¯</h4>
                    <div id="user2-regular-list" class="flex flex-wrap gap-2"></div>
                </div>
            </div>
        </div>

        <div class="mt-8 bg-white p-6 rounded-lg shadow border-2 border-purple-200">
            <h3 class="text-2xl font-bold mb-4 text-purple-700 flex items-center"><span class="mr-2">ğŸ’³</span> æœˆæœ«æ¸…ç®—</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                <div class="p-5 rounded-xl border-2 border-yellow-300 bg-yellow-50 shadow-inner">
                    <h4 class="font-bold text-lg mb-3 text-yellow-800">å¤ªé™½ ã®ç²¾ç®—</h4>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center text-gray-600"><span>ç·åˆè¨ˆ:</span><span id="user1-settlement-total" class="font-bold">0å††</span></div>
                        <div class="flex justify-between items-center"><span class="text-gray-700">è¿”é‡‘é¡:</span><input id="user1-refund" type="number" class="w-32 p-2 border rounded text-right font-bold" /></div>
                        <div class="flex justify-between items-center pt-3 border-t"><span>ç¿ŒæœˆæŒè¶Š:</span><span id="user1-next-carryover" class="font-black text-xl text-yellow-900">0å††</span></div>
                    </div>
                </div>
                <div class="p-5 rounded-xl border-2 border-blue-300 bg-blue-50 shadow-inner">
                    <h4 class="font-bold text-lg mb-3 text-blue-800">æ„›è¯éŸ³ ã®ç²¾ç®—</h4>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center text-gray-600"><span>ç·åˆè¨ˆ:</span><span id="user2-settlement-total" class="font-bold">0å††</span></div>
                        <div class="flex justify-between items-center"><span class="text-gray-700">è¿”é‡‘é¡:</span><input id="user2-refund" type="number" class="w-32 p-2 border rounded text-right font-bold" /></div>
                        <div class="flex justify-between items-center pt-3 border-t"><span>ç¿ŒæœˆæŒè¶Š:</span><span id="user2-next-carryover" class="font-black text-xl text-blue-900">0å††</span></div>
                    </div>
                </div>
            </div>
            <div class="flex justify-center"><button id="settlementButton" class="px-10 py-4 bg-purple-600 text-white rounded-full font-black text-xl shadow-lg hover:bg-purple-700 hover:scale-105 transform transition duration-200">æœˆæœ«æ¸…ç®—ã‚’ç¢ºå®šã—ã¦ç¿Œæœˆã¸</button></div>
        </div>

        <div class="mt-6 flex justify-between items-center text-[10px] text-gray-400 px-2 italic"><span id="syncStatus">åŒæœŸä¸­...</span><button id="syncButton" class="underline">å¼·åˆ¶æ›´æ–°</button></div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbz8PHdXzxbXV8NByZ2XokBXNb4wPSi9JIEohoIWtM-fxvBxzKCHYIDCWs6cOQklY8h4/exec';
        
        const appState = {
            currentYear: new Date().getFullYear(),
            currentMonth: new Date().getMonth() + 1,
            carryOver: { user1: 0, user2: 0 },
            expenses: { user1: [], user2: [] },
            refundAmounts: { user1: 0, user2: 0 },
            // å®šæœŸæ”¯å‡ºã®è¨­å®šï¼ˆã“ã“ã§åˆ¤å®šç”¨ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŒ‡å®šï¼‰
            regularConfig: {
                user1: [
                    { label: 'é›»æ°—ä»£', keyword: 'é›»æ°—' },
                    { label: 'æ°´é“ä»£', keyword: 'æ°´é“' },
                    { label: 'ã‚¬ã‚¹ä»£', keyword: 'ã‚¬ã‚¹' }
                ],
                user2: [
                    { label: 'ã‚¬ã‚½ãƒªãƒ³ä»£', keyword: 'ã‚¬ã‚½ãƒªãƒ³' }
                ]
            }
        };

        const elements = {
            currentMonthDisplay: document.getElementById('currentMonthDisplay'),
            expenseForm: document.getElementById('expenseForm'),
            submitButton: document.getElementById('submitButton'),
            syncStatus: document.getElementById('syncStatus')
        };

        function formatCurrency(v) { return Math.floor(v).toLocaleString() + 'å††'; }

        async function callAPI(action, params = {}) {
            return new Promise((resolve, reject) => {
                const callbackName = 'cb_' + Math.random().toString(36).substr(2, 9);
                window[callbackName] = (data) => {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    if (data && data.success) resolve(data); else reject(new Error(data.error || 'API Error'));
                };
                const q = new URLSearchParams({ action, callback: callbackName, ...params });
                const script = document.createElement('script');
                script.src = `${API_URL}?${q.toString()}`;
                document.body.appendChild(script);
            });
        }

        function getStorageKey(u) { return `temp_refund_${appState.currentYear}_${appState.currentMonth}_${u}`; }

        async function loadData() {
            elements.syncStatus.textContent = 'åŒæœŸä¸­...';
            try {
                const res = await callAPI('getBatchData', { year: appState.currentYear, month: appState.currentMonth });
                if (res.success) {
                    appState.expenses.user1 = res.expenses.user1 || [];
                    appState.expenses.user2 = res.expenses.user2 || [];
                    appState.carryOver.user1 = parseFloat(res.carryOver.user1) || 0;
                    appState.carryOver.user2 = parseFloat(res.carryOver.user2) || 0;
                    appState.refundAmounts.user1 = parseFloat(res.refundAmounts.user1) || 0;
                    appState.refundAmounts.user2 = parseFloat(res.refundAmounts.user2) || 0;
                    
                    const temp1 = localStorage.getItem(getStorageKey('user1'));
                    const temp2 = localStorage.getItem(getStorageKey('user2'));
                    if (temp1 !== null) appState.refundAmounts.user1 = parseFloat(temp1);
                    if (temp2 !== null) appState.refundAmounts.user2 = parseFloat(temp2);

                    updateUI();
                    elements.syncStatus.textContent = `åŒæœŸæ¸ˆã¿: ${new Date().toLocaleTimeString()}`;
                }
            } catch (e) { elements.syncStatus.textContent = 'åŒæœŸã‚¨ãƒ©ãƒ¼'; }
        }

        function updateUI() {
            elements.currentMonthDisplay.textContent = `${appState.currentYear}å¹´${appState.currentMonth}æœˆ`;
            ['user1', 'user2'].forEach(u => {
                renderExpenses(u);
                renderRegularCheck(u); // å®šæœŸæ”¯å‡ºãƒã‚§ãƒƒã‚¯ã‚’æç”»
            });
            updateTotals();
        }

        function renderExpenses(userId) {
            const container = document.getElementById(`${userId}-expenses`);
            container.innerHTML = '';
            const items = appState.expenses[userId];
            if (items.length === 0) {
                container.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-400 italic">å…¥åŠ›ãªã—</td></tr>';
                return;
            }
            items.forEach(ex => {
                const tr = document.createElement('tr');
                tr.className = 'border-b hover:bg-gray-50';
                tr.innerHTML = `<td class="p-2">${ex.date}æ—¥</td><td class="p-2">${ex.description}</td><td class="p-2 text-right font-mono">${parseFloat(ex.amount).toLocaleString()}</td><td class="p-2 text-center"><button onclick="deleteExpense('${userId}', '${ex.id}')" class="text-red-400">âœ•</button></td>`;
                container.appendChild(tr);
            });
        }

        // â˜… å®šæœŸæ”¯å‡ºã®ãƒã‚§ãƒƒã‚¯åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ â˜…
        function renderRegularCheck(userId) {
            const listContainer = document.getElementById(`${userId}-regular-list`);
            listContainer.innerHTML = '';
            
            const config = appState.regularConfig[userId];
            const expenses = appState.expenses[userId];

            config.forEach(item => {
                // ã“ã“ãŒåˆ¤å®šã®ã‚­ãƒ¢ï¼šã€Œé›»æ°—ä»£ã€ã¨ã„ã†ãƒ©ãƒ™ãƒ«ã«å¯¾ã—ã€æ”¯å‡ºå†…å®¹ã«ã€Œé›»æ°—ã€ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹
                const isPaid = expenses.some(ex => ex.description && ex.description.includes(item.keyword));
                
                const badge = document.createElement('span');
                badge.className = `px-2 py-1 rounded text-[10px] font-bold border transition-all ${
                    isPaid 
                    ? 'bg-green-100 text-green-700 border-green-300' 
                    : 'bg-red-50 text-red-400 border-red-200 opacity-60'
                }`;
                badge.innerHTML = `${isPaid ? 'âœ…' : 'â­•'} ${item.label}`;
                listContainer.appendChild(badge);
            });
        }

        function updateTotals() {
            ['user1', 'user2'].forEach(u => {
                const currentSum = appState.expenses[u].reduce((s, e) => s + parseFloat(e.amount || 0), 0);
                const carry = appState.carryOver[u];
                const total = currentSum + carry;
                const refund = appState.refundAmounts[u];

                document.getElementById(`${u}-carryover`).textContent = formatCurrency(carry);
                document.getElementById(`${u}-current`).textContent = formatCurrency(currentSum);
                document.getElementById(`${u}-total`).textContent = formatCurrency(total);
                document.getElementById(`${u}-settlement-total`).textContent = formatCurrency(total);
                
                const refundInput = document.getElementById(`${u}-refund`);
                refundInput.value = refund || '';
                document.getElementById(`${u}-next-carryover`).textContent = formatCurrency(total - refund);
            });
        }

        function handleRefundInput(u, val) {
            const amount = parseFloat(val) || 0;
            appState.refundAmounts[u] = amount;
            localStorage.setItem(getStorageKey(u), amount);
            updateTotals();
        }

        document.getElementById('user1-refund').oninput = (e) => handleRefundInput('user1', e.target.value);
        document.getElementById('user2-refund').oninput = (e) => handleRefundInput('user2', e.target.value);

        document.getElementById('settlementButton').onclick = async () => {
            if (!confirm('ç²¾ç®—ã‚’ç¢ºå®šã—ã€ç¿Œæœˆã¸ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ')) return;
            try {
                for (const u of ['user1', 'user2']) {
                    const total = appState.expenses[u].reduce((s, e) => s + parseFloat(e.amount || 0), 0) + appState.carryOver[u];
                    const refund = appState.refundAmounts[u];
                    await callAPI('settlement', {
                        data: JSON.stringify({
                            userId: u, year: appState.currentYear, month: appState.currentMonth,
                            currentTotal: total, refund: refund, nextCarryOver: total - refund,
                            settlementDate: new Date().toLocaleString('ja-JP')
                        })
                    });
                    localStorage.removeItem(getStorageKey(u));
                }
                alert('ç²¾ç®—å®Œäº†ï¼');
                appState.currentMonth++;
                if (appState.currentMonth > 12) { appState.currentMonth = 1; appState.currentYear++; }
                loadData();
            } catch (e) { alert('ç²¾ç®—ã‚¨ãƒ©ãƒ¼'); }
        };

        elements.expenseForm.onsubmit = async (e) => {
            e.preventDefault();
            const data = {
                userId: document.getElementById('userSelect').value,
                date: document.getElementById('dateInput').value,
                description: document.getElementById('descriptionInput').value,
                amount: parseFloat(document.getElementById('amountInput').value),
                year: appState.currentYear, month: appState.currentMonth
            };
            if (!data.date || !data.description || isNaN(data.amount)) return alert('å…¥åŠ›ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
            elements.submitButton.disabled = true;
            try {
                await callAPI('saveExpense', { data: JSON.stringify(data) });
                elements.expenseForm.reset();
                await loadData();
            } catch (err) { alert('ä¿å­˜å¤±æ•—'); }
            finally { elements.submitButton.disabled = false; }
        };

        window.deleteExpense = async (userId, id) => {
            if (confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { await callAPI('deleteExpense', { id }); loadData(); }
        };

        function changeMonth(dir) {
            appState.currentMonth += dir;
            if (appState.currentMonth > 12) { appState.currentMonth = 1; appState.currentYear++; }
            if (appState.currentMonth < 1) { appState.currentMonth = 12; appState.currentYear--; }
            loadData();
        }

        document.getElementById('prevMonth').onclick = () => changeMonth(-1);
        document.getElementById('nextMonth').onclick = () => changeMonth(1);
        document.getElementById('syncButton').onclick = () => loadData();

        loadData();
    </script>
</body>
</html>
