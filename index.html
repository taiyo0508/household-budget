<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>家計簿アプリ - 安定版</title>
  <script src="<https://cdn.tailwindcss.com>"></script>
  <style>
    input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; }
  </style>
</head>

<body class="bg-gray-100 min-h-screen pb-10 font-sans text-gray-800">
  <div id="app" class="max-w-6xl mx-auto p-4">
    <h1 class="text-3xl font-bold text-center my-6">家計簿アプリ</h1>

    <!-- 月移動 -->
    <div class="bg-white p-4 rounded-xl shadow mb-6 flex justify-between items-center border-b-4 border-blue-500">
      <button id="prevMonth" class="px-6 py-2 bg-blue-500 text-white rounded-lg shadow hover:bg-blue-600 transition-colors">前月</button>
      <h2 id="currentMonthDisplay" class="text-2xl font-bold">----</h2>
      <button id="nextMonth" class="px-6 py-2 bg-blue-500 text-white rounded-lg shadow hover:bg-blue-600 transition-colors">次月</button>
    </div>

    <!-- 入力フォーム -->
    <div class="bg-white p-6 rounded-xl shadow mb-6 border-l-8 border-green-500">
      <form id="expenseForm" class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <select id="userSelect" class="p-3 border rounded-lg font-bold">
          <option value="user1">太陽</option>
          <option value="user2">愛華音</option>
        </select>

        <input id="dateInput" type="number" placeholder="日" class="p-3 border rounded-lg" />
        <input id="descriptionInput" type="text" placeholder="内容（例：電気）" class="p-3 border rounded-lg" />

        <div class="flex gap-2">
          <input id="amountInput" type="number" placeholder="金額" class="p-3 border rounded-lg flex-1 font-mono" />
          <button id="submitButton" type="submit"
            class="px-6 py-3 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600 transition-transform active:scale-95">
            追加
          </button>
        </div>
      </form>
    </div>

    <!-- 一覧 -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- user1 -->
      <div class="bg-white p-6 rounded-xl shadow border-t-4 border-yellow-400">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-yellow-600">太陽</h3>
          <div id="user1-regular-list" class="flex flex-wrap gap-1"></div>
        </div>

        <div class="mb-4 p-3 bg-gray-50 rounded-lg text-sm space-y-1">
          <p class="flex justify-between"><span>前月持越し:</span> <span id="user1-carryover" class="font-bold">0円</span></p>
          <p class="flex justify-between text-blue-600"><span>当月合計:</span> <span id="user1-current">0円</span></p>
          <p class="flex justify-between border-t pt-1 font-bold text-lg"><span>総合計:</span> <span id="user1-total">0円</span></p>
        </div>

        <table class="w-full text-sm">
          <tbody id="user1-expenses"></tbody>
        </table>
      </div>

      <!-- user2 -->
      <div class="bg-white p-6 rounded-xl shadow border-t-4 border-blue-400">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-blue-600">愛華音</h3>
          <div id="user2-regular-list" class="flex flex-wrap gap-1"></div>
        </div>

        <div class="mb-4 p-3 bg-gray-50 rounded-lg text-sm space-y-1">
          <p class="flex justify-between"><span>前月持越し:</span> <span id="user2-carryover" class="font-bold">0円</span></p>
          <p class="flex justify-between text-blue-600"><span>当月合計:</span> <span id="user2-current">0円</span></p>
          <p class="flex justify-between border-t pt-1 font-bold text-lg"><span>総合計:</span> <span id="user2-total">0円</span></p>
        </div>

        <table class="w-full text-sm">
          <tbody id="user2-expenses"></tbody>
        </table>
      </div>
    </div>

    <!-- 月末清算 -->
    <div class="mt-8 bg-white p-6 rounded-xl shadow border-2 border-purple-300">
      <h3 class="text-2xl font-bold mb-6 text-purple-700 flex items-center gap-2">月末清算</h3>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
        <!-- user1 settlement -->
        <div class="p-5 rounded-2xl border-2 border-yellow-300 bg-yellow-50">
          <h4 class="font-bold mb-3">太陽 の精算</h4>
          <div class="space-y-3">
            <div class="flex justify-between"><span>現在の合計:</span><span id="user1-settlement-total" class="font-bold">0円</span></div>
            <div class="flex justify-between items-center">
              <span class="text-red-600 font-bold italic text-sm">返金額（自動保存）:</span>
              <input id="user1-refund" type="number"
                class="w-32 p-2 border-2 border-yellow-400 rounded-lg text-right font-bold focus:bg-white" />
            </div>
            <div class="flex justify-between pt-3 border-t-2 border-yellow-200">
              <span class="font-bold">翌月持越額（計算値）:</span>
              <span id="user1-next-carryover" class="font-black text-2xl text-yellow-900">0円</span>
            </div>
          </div>
        </div>

        <!-- user2 settlement -->
        <div class="p-5 rounded-2xl border-2 border-blue-300 bg-blue-50">
          <h4 class="font-bold mb-3">愛華音 の精算</h4>
          <div class="space-y-3">
            <div class="flex justify-between"><span>現在の合計:</span><span id="user2-settlement-total" class="font-bold">0円</span></div>
            <div class="flex justify-between items-center">
              <span class="text-red-600 font-bold italic text-sm">返金額（自動保存）:</span>
              <input id="user2-refund" type="number"
                class="w-32 p-2 border-2 border-blue-400 rounded-lg text-right font-bold focus:bg-white" />
            </div>
            <div class="flex justify-between pt-3 border-t-2 border-blue-200">
              <span class="font-bold">翌月持越額（計算値）:</span>
              <span id="user2-next-carryover" class="font-black text-2xl text-blue-900">0円</span>
            </div>
          </div>
        </div>
      </div>

      <div class="flex flex-col items-center gap-4">
        <button id="settlementButton"
          class="px-12 py-4 bg-purple-600 text-white rounded-full font-black text-xl shadow-lg hover:bg-purple-700 transition-transform active:scale-95">
          精算を確定（返金額を保存）
        </button>
        <p id="settlementStatus" class="text-sm font-bold text-gray-400"></p>
      </div>
    </div>

    <div class="mt-8 text-center">
      <button id="syncButton" class="text-xs text-gray-400 underline decoration-dotted">データを強制更新</button>
    </div>
  </div>

  <script>
    // あなたのGAS URLに置き換えてください
    const API_URL = '<https://script.google.com/macros/s/AKfycbzIlgKfMN0HD8FiYWJctIl2oujPCX6SfOxNAvpoBdahcuC6oz7OY0JFQCPUryVWftx1/exec';

    const appState = {
      currentYear: new Date().getFullYear(),
      currentMonth: new Date().getMonth() + 1,
      carryOver: { user1: 0, user2: 0 },
      expenses: { user1: [], user2: [] },
      refundAmounts: { user1: 0, user2: 0 },
      settlementDate: null,
      regularConfig: {
        user1: [
          { label: '電気', keyword: '電気' },
          { label: '水道', keyword: '水道' },
          { label: 'ガス', keyword: 'ガス' },
        ],
        user2: [
          { label: 'ガソリン', keyword: 'ガソリン' }
        ]
      }
    };

    function debounce(fn, wait) {
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...args), wait);
      };
    }

    // JSONP
    async function callAPI(action, params = {}) {
      return new Promise((resolve, reject) => {
        const cb = 'cb_' + Math.random().toString(36).slice(2);
        const s = document.createElement('script');

        window[cb] = (d) => {
          try {
            delete window[cb];
            if (s && s.parentNode) s.parentNode.removeChild(s);
          } catch (_) {}

          if (d && d.success) resolve(d);
          else reject(new Error((d && d.error) ? d.error : 'API error'));
        };

        const query = new URLSearchParams({
          action,
          callback: cb,
          _t: Date.now(), // キャッシュ回避
          ...params
        }).toString();

        s.src = `${API_URL}?${query}`;
        s.onerror = () => {
          try { delete window[cb]; } catch(_) {}
          reject(new Error('JSONP load error'));
        };

        document.body.appendChild(s);
      });
    }

    async function loadData() {
      const status = document.getElementById('settlementStatus');
      status.textContent = '同期中...';

      try {
        const res = await callAPI('getBatchData', {
          year: appState.currentYear,
          month: appState.currentMonth
        });

        appState.expenses = res.expenses || { user1: [], user2: [] };
        appState.carryOver = res.carryOver || { user1: 0, user2: 0 };
        appState.refundAmounts = res.refundAmounts || { user1: 0, user2: 0 };
        appState.settlementDate = res.settlementDate || null;

        updateUI();

        status.textContent = appState.settlementDate ? `精算記録あり: ${appState.settlementDate}` : '';
      } catch (e) {
        status.textContent = '同期失敗';
        console.error(e);
      }
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    function updateUI() {
      document.getElementById('currentMonthDisplay').textContent =
        `${appState.currentYear}年${appState.currentMonth}月`;

      ['user1', 'user2'].forEach(u => {
        // 明細
        const tbody = document.getElementById(`${u}-expenses`);
        const items = appState.expenses[u] || [];

        tbody.innerHTML = items.map(ex => {
          const day = escapeHtml(ex.date);
          const desc = escapeHtml(ex.description || '');
          const amt = Number(ex.amount || 0);

          return `
            <tr class="border-b">
              <td class="p-2 text-xs text-gray-400 font-bold">${day}日</td>
              <td class="p-2 font-medium">${desc}</td>
              <td class="p-2 text-right font-bold">${amt.toLocaleString()}</td>
              <td class="p-2 text-right">
                <button class="text-red-300 hover:text-red-500" onclick="window.deleteExpense('${u}','${ex.id}')">✕</button>
              </td>
            </tr>
          `;
        }).join('');

        // 定期支払チェック
        const regBox = document.getElementById(`${u}-regular-list`);
        const reg = appState.regularConfig[u] || [];
        regBox.innerHTML = reg.map(item => {
          const ok = items.some(ex => (ex.description || '').includes(item.keyword));
          return `
            <span class="px-1.5 py-0.5 rounded text-[9px] font-black border
              ${ok ? 'bg-green-500 text-white border-green-500' : 'bg-gray-100 text-gray-300 border-gray-200'}">
              ${escapeHtml(item.label)}
            </span>
          `;
        }).join('');

        // 合計
        const cur = items.reduce((s, e) => s + Number(e.amount || 0), 0);
        const carry = Number(appState.carryOver[u] || 0);
        const total = cur + carry;

        document.getElementById(`${u}-carryover`).textContent = `${carry.toLocaleString()}円`;
        document.getElementById(`${u}-current`).textContent = `${cur.toLocaleString()}円`;
        document.getElementById(`${u}-total`).textContent = `${total.toLocaleString()}円`;
        document.getElementById(`${u}-settlement-total`).textContent = `${total.toLocaleString()}円`;

        // 返金額（0を消さない）
        const ref = appState.refundAmounts[u];
        document.getElementById(`${u}-refund`).value =
          (ref === null || ref === undefined) ? 0 : ref;

        const nextCarry = total - Number((ref === null || ref === undefined) ? 0 : ref);
        document.getElementById(`${u}-next-carryover`).textContent = `${nextCarry.toLocaleString()}円`;
      });
    }

    // 返金額の自動保存（E列）
    const autoSaveRefund = debounce(async (userId, raw) => {
      const v = Number(raw);
      const refund = Number.isFinite(v) ? v : 0;

      // 画面上でも即反映
      appState.refundAmounts[userId] = refund;
      updateUI();

      try {
        await callAPI('saveRefund', {
          data: JSON.stringify({
            userId,
            year: appState.currentYear,
            month: appState.currentMonth,
            refund
          })
        });
      } catch (e) {
        console.error(e);
      }
    }, 700);

    document.getElementById('user1-refund').addEventListener('input', (e) => autoSaveRefund('user1', e.target.value));
    document.getElementById('user2-refund').addEventListener('input', (e) => autoSaveRefund('user2', e.target.value));

    // 精算確定（返金額固定＋履歴）
    document.getElementById('settlementButton').addEventListener('click', async () => {
      if (!confirm('精算記録を残しますか？（返金額を保存します）')) return;

      try {
        for (const u of ['user1', 'user2']) {
          const items = appState.expenses[u] || [];
          const cur = items.reduce((s, e) => s + Number(e.amount || 0), 0);
          const carry = Number(appState.carryOver[u] || 0);
          const total = cur + carry;

          const ref = appState.refundAmounts[u];
          const refund = (ref === null || ref === undefined) ? 0 : Number(ref);

          await callAPI('settlement', {
            data: JSON.stringify({
              userId: u,
              year: appState.currentYear,
              month: appState.currentMonth,
              currentTotal: total,
              refund: refund,
              nextCarryOver: total - refund,
              settlementDate: new Date().toLocaleString('ja-JP')
            })
          });
        }

        alert('精算記録を保存しました。');
        await loadData();
      } catch (e) {
        console.error(e);
        alert('精算の保存に失敗しました。');
      }
    });

    // 支出追加
    document.getElementById('expenseForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const userId = document.getElementById('userSelect').value;
      const date = document.getElementById('dateInput').value;
      const description = document.getElementById('descriptionInput').value;
      const amount = Number(document.getElementById('amountInput').value);

      if (!date || !description || !Number.isFinite(amount)) {
        alert('入力を確認してください');
        return;
      }

      const data = {
        userId,
        date: date,
        description: description,
        amount: amount,
        year: appState.currentYear,
        month: appState.currentMonth
      };

      try {
        await callAPI('saveExpense', { data: JSON.stringify(data) });
        document.getElementById('expenseForm').reset();
        await loadData();
      } catch (e2) {
        console.error(e2);
        alert('保存に失敗しました');
      }
    });

    // 支出削除
    window.deleteExpense = async (_userId, id) => {
      if (!confirm('削除しますか？')) return;
      try {
        await callAPI('deleteExpense', { id });
        await loadData();
      } catch (e) {
        console.error(e);
        alert('削除に失敗しました');
      }
    };

    function changeMonth(dir) {
      appState.currentMonth += dir;
      if (appState.currentMonth > 12) { appState.currentMonth = 1; appState.currentYear++; }
      if (appState.currentMonth < 1) { appState.currentMonth = 12; appState.currentYear--; }
      loadData();
    }

    document.getElementById('prevMonth').addEventListener('click', () => changeMonth(-1));
    document.getElementById('nextMonth').addEventListener('click', () => changeMonth(1));
    document.getElementById('syncButton').addEventListener('click', () => loadData());

    loadData();
  </script>
</body>
</html>
